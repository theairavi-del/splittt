        // State Management (inline since agent files aren't easily importable)
        const EMOJIS = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','üê§','ü¶Ü'];
        
        let appState = {
            roomCode: null,
            userId: null,
            userName: null,
            userEmoji: null,
            isHost: false,
            session: null,
            selectedItem: null,
            tempUnits: 0
        };

        // Initialize
        window.onload = () => {
            loadSession();
            initAvatars();
            startSyncLoop();
        };

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Session Management
        function loadSession() {
            const saved = localStorage.getItem('splitt_current');
            if (saved) {
                appState = JSON.parse(saved);
                if (appState.session) {
                    const sessionData = localStorage.getItem(`splitt_${appState.roomCode}`);
                    if (sessionData) {
                        appState.session = JSON.parse(sessionData);
                    }
                }
            }
        }

        function saveSession() {
            localStorage.setItem('splitt_current', JSON.stringify(appState));
            if (appState.session) {
                localStorage.setItem(`splitt_${appState.roomCode}`, JSON.stringify(appState.session));
            }
        }

        function startSyncLoop() {
            setInterval(() => {
                if (appState.roomCode && !appState.isHost) {
                    const data = localStorage.getItem(`splitt_${appState.roomCode}`);
                    if (data) {
                        const newSession = JSON.parse(data);
                        if (newSession.lastModified > appState.session?.lastModified) {
                            appState.session = newSession;
                            updateUI();
                        }
                    }
                }
            }, 1000);
        }

        // Navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId + 'Screen').classList.add('active');
        }

        // Welcome
        function createRoom() {
            appState.roomCode = generateRoomCode();
            appState.isHost = true;
            appState.userId = generateId();
            showScreen('name');
        }

        function showJoin() {
            showScreen('join');
            setTimeout(() => document.getElementById('code1').focus(), 100);
        }

        // Join Code
        function nextCode(n) {
            if (n < 6) document.getElementById(`code${n+1}`).focus();
        }

        function joinRoom() {
            const code = Array.from({length: 6}, (_, i) => document.getElementById(`code${i+1}`).value).join('').toUpperCase();
            if (code.length !== 6) return;
            
            const sessionData = localStorage.getItem(`splitt_${code}`);
            if (!sessionData) {
                alert('Room not found!');
                return;
            }
            
            appState.roomCode = code;
            appState.isHost = false;
            appState.userId = generateId();
            appState.session = JSON.parse(sessionData);
            showScreen('name');
        }

        // Avatar Selection
        function initAvatars() {
            const grid = document.getElementById('avatarGrid');
            EMOJIS.forEach((emoji, i) => {
                const div = document.createElement('div');
                div.className = `avatar cursor-pointer ${i === 0 ? 'active' : ''}`;
                div.textContent = emoji;
                div.onclick = () => {
                    document.querySelectorAll('#avatarGrid .avatar').forEach(a => a.classList.remove('active'));
                    div.classList.add('active');
                    appState.userEmoji = emoji;
                };
                grid.appendChild(div);
            });
            appState.userEmoji = EMOJIS[0];
        }

        function setUser() {
            const name = document.getElementById('userName').value.trim();
            if (!name) return alert('Enter your name!');
            
            appState.userName = name;
            
            if (!appState.session) {
                // Creating new session
                appState.session = {
                    roomCode: appState.roomCode,
                    hostId: appState.userId,
                    status: 'lobby',
                    createdAt: Date.now(),
                    participants: [],
                    items: [],
                    tax: 0,
                    tip: 0,
                    selections: {},
                    lastModified: Date.now()
                };
            }
            
            // Add participant
            appState.session.participants.push({
                id: appState.userId,
                name: appState.userName,
                emoji: appState.userEmoji,
                isHost: appState.isHost
            });
            
            saveSession();
            showLobby();
        }

        // Lobby
        function showLobby() {
            showScreen('lobby');
            document.getElementById('lobbyCode').textContent = appState.roomCode;
            document.getElementById('startBtn').classList.toggle('hidden', !appState.isHost);
            renderPlayers();
        }

        function renderPlayers() {
            const grid = document.getElementById('playerGrid');
            grid.innerHTML = '';
            appState.session?.participants?.forEach(p => {
                const div = document.createElement('div');
                div.className = 'flex flex-col items-center';
                div.innerHTML = `
                    <div class="avatar mb-2 ${p.id === appState.userId ? 'active' : ''}">${p.emoji}</div>
                    <span class="text-xs text-gray-400 text-center">${p.name}${p.isHost ? ' üëë' : ''}</span>
                `;
                grid.appendChild(div);
            });
        }

        function startGame() {
            appState.session.status = 'selecting';
            appState.session.lastModified = Date.now();
            saveSession();
            showScreen('receipt');
        }

        function leaveRoom() {
            localStorage.removeItem('splitt_current');
            location.reload();
        }

        // Receipt Parsing
        function parseReceipt() {
            const text = document.getElementById('receiptText').value;
            if (!text.trim()) return alert('Paste receipt text first!');
            
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const items = [];
            let tax = 0, tip = 0;
            
            lines.forEach(line => {
                // Match patterns like "2x Wings $24.00" or "Wings $12.00"
                const match = line.match(/(\d+)x?\s+(.+?)\s+\$?([\d.]+)/i);
                if (match) {
                    const qty = parseInt(match[1]) || 1;
                    const name = match[2].trim();
                    const price = parseFloat(match[3]);
                    
                    if (name.toLowerCase().includes('tax')) tax = price;
                    else if (name.toLowerCase().includes('tip')) tip = price;
                    else if (!name.toLowerCase().includes('total')) {
                        items.push({ id: generateId(), name, price, quantity: qty, claimed: false });
                    }
                }
            });
            
            appState.session.items = items;
            appState.session.tax = tax;
            appState.session.tip = tip;
            appState.session.selections = {};
            saveSession();
            showReview();
        }

        // Review Items
        function showReview() {
            showScreen('review');
            const list = document.getElementById('itemsList');
            list.innerHTML = '';
            
            appState.session.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold">${item.quantity > 1 ? item.quantity + 'x ' : ''}${item.name}</div>
                            <div class="text-sm text-gray-400">$${item.price.toFixed(2)}</div>
                        </div>
                        <button class="btn btn-outline btn-small" onclick="editItem('${item.id}')">‚úèÔ∏è</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function goToDraft() {
            appState.session.status = 'selecting';
            appState.session.lastModified = Date.now();
            saveSession();
            showDraft();
        }

        // Draft / Item Selection
        function showDraft() {
            showScreen('draft');
            renderDraft();
        }

        function renderDraft() {
            const list = document.getElementById('draftList');
            list.innerHTML = '';
            
            let claimedCount = 0;
            let orphanCount = 0;
            let myTotal = 0;
            
            appState.session.items.forEach(item => {
                const selections = appState.session.selections[item.id] || [];
                const mySelection = selections.find(s => s.userId === appState.userId);
                const isClaimed = selections.length > 0;
                const isOrphan = !isClaimed;
                
                if (isClaimed) claimedCount++;
                if (isOrphan) orphanCount++;
                
                // Calculate my share
                if (mySelection) {
                    if (mySelection.type === 'solo') myTotal += item.price;
                    else if (mySelection.type === 'even') myTotal += item.price / selections.length;
                    else if (mySelection.type === 'unit') {
                        myTotal += (mySelection.value / item.quantity) * item.price;
                    }
                }
                
                const div = document.createElement('div');
                div.className = `item-card ${isOrphan ? 'unclaimed' : ''}`;
                
                let claimantsHtml = '';
                if (selections.length > 0) {
                    claimantsHtml = `<div class="flex gap-2 mt-2">` + selections.map(s => {
                        const p = appState.session.participants.find(x => x.id === s.userId);
                        let label = s.type === 'solo' ? 'solo' : s.type === 'even' ? 'split' : `${s.value}/${item.quantity}`;
                        return `<span class="text-xs bg-gray-800 px-2 py-1 rounded">${p?.emoji || '?'} ${label}</span>`;
                    }).join('') + `</div>`;
                }
                
                let actionsHtml = '';
                if (mySelection) {
                    actionsHtml = `<button class="btn btn-error text-sm py-2" onclick="unclaimItem('${item.id}')">Remove</button>`;
                } else if (!selections.find(s => s.type === 'solo')) {
                    actionsHtml = `
                        <button class="btn btn-success text-sm py-2" onclick="showSplitModal('${item.id}')">Claim</button>
                    `;
                } else {
                    actionsHtml = `<span class="text-sm text-gray-500">Solo claimed</span>`;
                }
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold">${item.quantity > 1 ? item.quantity + 'x ' : ''}${item.name}</div>
                            <div class="text-green-400 font-bold">$${item.price.toFixed(2)}</div>
                            ${claimantsHtml}
                        </div>
                        <div>${actionsHtml}</div>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Update progress
            document.getElementById('draftProgress').textContent = `${claimedCount}/${appState.session.items.length} claimed`;
            document.getElementById('orphanAlert').classList.toggle('hidden', orphanCount === 0);
            document.getElementById('orphanCount').textContent = orphanCount;
            
            // Calculate with tax/tip
            const subtotal = myTotal;
            const totalFood = appState.session.items.reduce((sum, i) => sum + i.price, 0);
            const myTax = totalFood > 0 ? (subtotal / totalFood) * appState.session.tax : 0;
            const myTip = totalFood > 0 ? (subtotal / totalFood) * appState.session.tip : 0;
            const total = subtotal + myTax + myTip;
            
            document.getElementById('runningTotal').textContent = '$' + total.toFixed(2);
        }

        function showSplitModal(itemId) {
            appState.selectedItem = itemId;
            const item = appState.session.items.find(i => i.id === itemId);
            document.getElementById('unitBtn').classList.toggle('hidden', item.quantity <= 1);
            document.getElementById('splitModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            appState.selectedItem = null;
        }

        function claimItem(type) {
            if (!appState.selectedItem) return;
            
            const itemId = appState.selectedItem;
            
            if (type === 'unit') {
                showUnitSplit();
                return;
            }
            
            if (!appState.session.selections[itemId]) {
                appState.session.selections[itemId] = [];
            }
            
            // Remove existing selection for this user
            appState.session.selections[itemId] = appState.session.selections[itemId].filter(s => s.userId !== appState.userId);
            
            // If solo, clear others
            if (type === 'solo') {
                appState.session.selections[itemId] = [];
            }
            
            appState.session.selections[itemId].push({
                userId: appState.userId,
                type: type,
                value: type === 'even' ? null : 1
            });
            
            appState.session.lastModified = Date.now();
            saveSession();
            closeModal();
            renderDraft();
        }

        function unclaimItem(itemId) {
            if (appState.session.selections[itemId]) {
                appState.session.selections[itemId] = appState.session.selections[itemId].filter(s => s.userId !== appState.userId);
                if (appState.session.selections[itemId].length === 0) {
                    delete appState.session.selections[itemId];
                }
                appState.session.lastModified = Date.now();
                saveSession();
                renderDraft();
            }
        }

        // Unit Split
        function showUnitSplit() {
            const item = appState.session.items.find(i => i.id === appState.selectedItem);
            document.getElementById('totalUnits').textContent = item.quantity;
            document.getElementById('myUnits').textContent = '0';
            document.getElementById('unitShare').textContent = '0.00';
            appState.tempUnits = 0;
            closeModal();
            document.getElementById('unitModal').classList.add('active');
        }

        function adjustUnit(delta) {
            const item = appState.session.items.find(i => i.id === appState.selectedItem);
            appState.tempUnits = Math.max(0, Math.min(item.quantity, appState.tempUnits + delta));
            document.getElementById('myUnits').textContent = appState.tempUnits;
            const share = (appState.tempUnits / item.quantity) * item.price;
            document.getElementById('unitShare').textContent = share.toFixed(2);
        }

        function confirmUnitClaim() {
            if (appState.tempUnits === 0) {
                closeModal();
                return;
            }
            
            const itemId = appState.selectedItem;
            if (!appState.session.selections[itemId]) {
                appState.session.selections[itemId] = [];
            }
            
            appState.session.selections[itemId] = appState.session.selections[itemId].filter(s => s.userId !== appState.userId);
            appState.session.selections[itemId].push({
                userId: appState.userId,
                type: 'unit',
                value: appState.tempUnits
            });
            
            appState.session.lastModified = Date.now();
            saveSession();
            closeModal();
            renderDraft();
        }

        // Review Split
        function reviewSplit() {
            showPersonalReview();
        }

        function showPersonalReview() {
            showScreen('personalReview');
            
            let mySubtotal = 0;
            const myItems = [];
            
            appState.session.items.forEach(item => {
                const selections = appState.session.selections[item.id] || [];
                const mySel = selections.find(s => s.userId === appState.userId);
                
                if (mySel) {
                    let amount = 0;
                    if (mySel.type === 'solo') amount = item.price;
                    else if (mySel.type === 'even') amount = item.price / selections.length;
                    else if (mySel.type === 'unit') amount = (mySel.value / item.quantity) * item.price;
                    
                    mySubtotal += amount;
                    myItems.push({ name: item.name, amount, type: mySel.type });
                }
            });
            
            const totalFood = appState.session.items.reduce((sum, i) => sum + i.price, 0);
            const myTax = totalFood > 0 ? (mySubtotal / totalFood) * appState.session.tax : 0;
            const myTip = totalFood > 0 ? (mySubtotal / totalFood) * appState.session.tip : 0;
            const total = mySubtotal + myTax + myTip;
            
            document.getElementById('personalTotal').textContent = '$' + total.toFixed(2);
            
            const list = document.getElementById('personalItems');
            list.innerHTML = '';
            
            myItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between py-2 border-b border-gray-800';
                div.innerHTML = `
                    <span class="text-gray-400">${item.name} <span class="text-xs">(${item.type})</span></span>
                    <span class="font-bold">$${item.amount.toFixed(2)}</span>
                `;
                list.appendChild(div);
            });
            
            // Add tax/tip
            if (myTax > 0) {
                list.innerHTML += `<div class="flex justify-between py-2 text-gray-400"><span>Tax</span><span>$${myTax.toFixed(2)}</span></div>`;
            }
            if (myTip > 0) {
                list.innerHTML += `<div class="flex justify-between py-2 text-gray-400"><span>Tip</span><span>$${myTip.toFixed(2)}</span></div>`;
            }
        }

        // Group Summary
        function showGroupSummary() {
            showScreen('summary');
            const container = document.getElementById('groupSummary');
            container.innerHTML = '';
            
            const totals = [];
            
            appState.session.participants.forEach(p => {
                let subtotal = 0;
                
                appState.session.items.forEach(item => {
                    const selections = appState.session.selections[item.id] || [];
                    const sel = selections.find(s => s.userId === p.id);
                    
                    if (sel) {
                        if (sel.type === 'solo') subtotal += item.price;
                        else if (sel.type === 'even') subtotal += item.price / selections.length;
                        else if (sel.type === 'unit') subtotal += (sel.value / item.quantity) * item.price;
                    }
                });
                
                const totalFood = appState.session.items.reduce((sum, i) => sum + i.price, 0);
                const tax = totalFood > 0 ? (subtotal / totalFood) * appState.session.tax : 0;
                const tip = totalFood > 0 ? (subtotal / totalFood) * appState.session.tip : 0;
                
                totals.push({
                    participant: p,
                    subtotal,
                    tax,
                    tip,
                    total: subtotal + tax + tip
                });
            });
            
            totals.sort((a, b) => b.total - a.total);
            
            totals.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = 'item-card mb-3';
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="text-2xl">${t.participant.emoji}</div>
                        <div class="flex-1">
                            <div class="font-bold">${t.participant.name}${t.participant.id === appState.userId ? ' (You)' : ''}</div>
                            <div class="text-xs text-gray-400">${i === 0 ? 'üëë Highest' : ''}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-green-400">$${t.total.toFixed(2)}</div>
                            ${t.participant.id !== appState.userId ? `<a href="venmo://paycharge?txn=pay&amount=${t.total.toFixed(2)}&note=SPLITT" class="text-xs text-blue-400">Pay with Venmo</a>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function resetApp() {
            localStorage.removeItem('splitt_current');
            if (appState.roomCode) {
                localStorage.removeItem(`splitt_${appState.roomCode}`);
            }
            location.reload();
        }

        function updateUI() {
            // Auto-refresh based on session status
            if (appState.session?.status === 'selecting' && document.getElementById('lobbyScreen').classList.contains('active')) {
                showDraft();
            }
            if (appState.screen === 'lobby') renderPlayers();
            if (appState.screen === 'draft') renderDraft();
        }
    </script>
</body>
</html>